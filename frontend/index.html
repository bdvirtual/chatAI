<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>ChatAI</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#f7f7f8;
    --panel:#ffffff;
    --text:#0c0c0d;
    --muted:#6b7280;
    --border:#e5e7eb;
    --accent:#10a37f;
    --shadow:0 8px 30px rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font:16px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif;}
  .app{display:grid;grid-template-columns:280px 1fr;height:100vh}

  /* Sidebar */
  .sidebar{display:flex;flex-direction:column;gap:12px;padding:12px;border-right:1px solid var(--border);background:#fff}
  .brand{display:flex;align-items:center;gap:10px;margin:4px 6px 6px;font-weight:700}
  .brand .dot{width:28px;height:28px;border-radius:8px;background:var(--accent)}
  .new-chat{display:flex;gap:10px;align-items:center;justify-content:center;background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px;cursor:pointer}
  .new-chat:hover{border-color:#cfd3d8}
  .history{flex:1;overflow:auto;padding-right:4px}
  .conv{display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--border);border-radius:12px;margin-bottom:8px;background:#fff;cursor:pointer}
  .conv.active{border-color:var(--accent);box-shadow:0 6px 24px rgba(16,163,127,.08)}
  .conv .title{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
  .muted{color:var(--muted);font-size:12px;margin:2px 0 0 2px}

  /* Main */
  .main{display:flex;flex-direction:column;height:100vh}
  .scroll{flex:1;overflow:auto}
  .inner{max-width:800px;margin:0 auto;padding:24px;display:flex;flex-direction:column;gap:18px}

  .row{display:grid;grid-template-columns:40px 1fr;gap:12px;align-items:flex-start}
  .avatar{
    width:40px;height:40px;border-radius:8px;display:grid;place-items:center;font-weight:700;color:#fff;
    background:#19c37d;font-size:20px
  }
  .avatar.user{background:#7c8ea0}
  .bubble{
    background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;
    box-shadow:var(--shadow);white-space:pre-wrap;word-wrap:break-word;
  }
  .meta{font-size:12px;color:var(--muted);margin-top:6px}

  /* Markdown */
  .md p{margin: 0 0 10px}
  .md ul,.md ol{margin:10px 0 10px 22px}
  .md code{
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    background:#f1f5f9;border:1px solid #e2e8f0;border-radius:6px;padding:2px 6px
  }
  .md pre{
    background:#0b1021;color:#e9f2ff;border-radius:12px;border:1px solid #0f1530;
    padding:14px;overflow:auto;box-shadow: inset 0 0 0 1px rgba(255,255,255,.02)
  }
  .md pre code{background:transparent;border:none;padding:0;color:inherit}

  /* Composer */
  .composer-wrap{
    position:sticky;bottom:0;padding:16px;border-top:1px solid var(--border);
    background:linear-gradient(180deg,rgba(247,247,248,0),var(--bg) 30%,var(--bg) 100%);
  }
  .composer{
    max-width:800px;margin:0 auto;background:#fff;border:1px solid var(--border);
    border-radius:18px;box-shadow:var(--shadow);padding:10px 12px;display:flex;gap:10px;align-items:flex-end
  }
  textarea{
    flex:1;border:none;outline:none;background:transparent;color:var(--text);
    font:16px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif;
    resize:none;min-height:24px;max-height:240px;overflow:auto
  }
  .actions{display:flex;gap:8px}
  .btn{border:none;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:600}
  .btn-send{background:var(--accent);color:#fff}
  .btn-send:hover{filter:brightness(.95)}
  .btn-stop{background:#ef4444;color:#fff;display:none}
  .hint{max-width:800px;margin:10px auto 0;color:var(--muted);font-size:12px;text-align:center}

  @media (max-width:980px){
    .app{grid-template-columns:1fr}
    .sidebar{display:none}
  }
</style>
</head>
<body>
<div class="app">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand"><div class="dot"></div>ChatAI</div>
    <button class="new-chat" id="newChatBtn">+ New chat</button>
    <div class="history" id="history"></div>
    <div class="muted">Chats are stored locally on this device.</div>
  </aside>

  <!-- MAIN -->
  <section class="main">
    <div class="scroll" id="scroll">
      <div class="inner" id="inner">
        <div class="row">
          <div class="avatar">ðŸ¤–</div>
          <div>
            <div class="bubble md">
              <p>Welcome! Iâ€™m <strong>ChatAI</strong>. Ask me anything.</p>
              <p><em>Enter</em> to send, <em>Shift+Enter</em> for a newline.</p>
            </div>
            <div class="meta">Ready</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Composer -->
    <div class="composer-wrap">
      <div class="composer">
        <textarea id="input" placeholder="Message ChatAI..."></textarea>
        <div class="actions">
          <button class="btn btn-stop" id="stop">Stop</button>
          <button class="btn btn-send" id="send" title="Send (Enter)">Send</button>
        </div>
      </div>
      <div class="hint">Running locally â€¢ Streams from <code>/chat-stream</code></div>
    </div>
  </section>
</div>

<script>
/* ===== Global state (FIXED: no duplicate declarations) ===== */
const inner = document.getElementById('inner');
const scroller = document.getElementById('scroll');
const input = document.getElementById('input');
const sendBtn = document.getElementById('send');
const stopBtn = document.getElementById('stop');
const historyEl = document.getElementById('history');
const newChatBtn = document.getElementById('newChatBtn');

let conversations = JSON.parse(localStorage.getItem('chatai_conversations') || '[]'); // [{id,title,turns,created}]
let currentId = localStorage.getItem('chatai_current') || null;
let turns = [];
let currentController = null; // for Stop

function saveAll(){
  localStorage.setItem('chatai_conversations', JSON.stringify(conversations));
  localStorage.setItem('chatai_current', currentId || '');
}
function newId(){ return 'c_' + Math.random().toString(36).slice(2,10); }

/* ===== Sidebar ===== */
function renderHistory(){
  historyEl.innerHTML = '';
  conversations.forEach(c=>{
    const div = document.createElement('div');
    div.className = 'conv' + (c.id===currentId ? ' active' : '');
    div.title = c.title || 'New chat';
    div.onclick = () => switchConv(c.id);
    div.innerHTML = `<div class="title">${c.title || 'New chat'}</div>`;
    historyEl.appendChild(div);
  });
}
function switchConv(id){
  currentId = id;
  const conv = conversations.find(x=>x.id===id);
  turns = conv ? [...conv.turns] : [];
  renderHistory();
  renderConversation();
}
function ensureCurrent(){
  if(!currentId){
    const id = newId();
    conversations.unshift({id, title:'New chat', turns:[], created:Date.now()});
    currentId = id;
    saveAll();
  }
}
newChatBtn.onclick = ()=>{
  currentId = null;
  ensureCurrent();
  turns = [];
  renderHistory();
  renderConversation();
};

/* ===== Markdown renderer ===== */
function escapeHtml(s){
  return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
}
function renderMarkdown(src){
  let s = escapeHtml(src);
  s = s.replace(/```([\s\S]*?)```/g, (_,code)=> `<pre><code>${code.replace(/</g,'&lt;')}</code></pre>`);
  s = s.replace(/`([^`]+)`/g, (_,code)=> `<span class="code-inline"><code>${code}</code></span>`);
  s = s.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
  s = s.replace(/\*([^*]+)\*/g, '<em>$1</em>');
  s = s.replace(/(https?:\/\/[^\s)]+)(?![^<]*>)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
  const lines = s.split(/\r?\n/);
  let out = '', inUL=false, inOL=false;
  for (let line of lines){
    if (/^\s*[-*]\s+/.test(line)){
      if(!inUL){ out += '<ul>'; inUL=true; }
      out += `<li>${line.replace(/^\s*[-*]\s+/, '')}</li>`;
    } else if (/^\s*\d+\.\s+/.test(line)){
      if(!inOL){ out += '<ol>'; inOL=true; }
      out += `<li>${line.replace(/^\s*\d+\.\s+/, '')}</li>`;
    } else {
      if(inUL){ out += '</ul>'; inUL=false; }
      if(inOL){ out += '</ol>'; inOL=false; }
      out += line.trim().length ? `<p>${line}</p>` : `<p></p>`;
    }
  }
  if(inUL) out += '</ul>';
  if(inOL) out += '</ol>';
  return out;
}

/* ===== Chat rendering ===== */
function addRow(role, text, isMarkdown=false){
  const row = document.createElement('div');
  row.className = 'row';
  const avatar = document.createElement('div');
  avatar.className = 'avatar ' + (role==='user'?'user':'assistant');
  avatar.textContent = role==='user' ? 'ðŸ‘¤' : 'ðŸ¤–';
  const right = document.createElement('div');
  const bubble = document.createElement('div');
  bubble.className = 'bubble ' + (role==='user'?'user':'assistant');
  if(isMarkdown){ bubble.classList.add('md'); bubble.innerHTML = renderMarkdown(text); }
  else { bubble.textContent = text; }
  const meta = document.createElement('div');
  meta.className = 'meta';
  meta.textContent = new Date().toLocaleTimeString();
  right.appendChild(bubble); right.appendChild(meta);
  row.appendChild(avatar); row.appendChild(right);
  inner.appendChild(row);
  scroller.scrollTop = scroller.scrollHeight;
  return bubble;
}
function renderConversation(){
  inner.innerHTML = '';
  if(!turns.length){
    addRow('assistant', 'New chat. Ask me anything!', true);
  } else {
    turns.forEach(t=> addRow(t.role, t.content, t.role==='assistant'));
  }
  scroller.scrollTop = scroller.scrollHeight;
}

/* ===== Messaging (stream + Stop) ===== */
async function sendMessage(){
  const text = input.value.trim();
  if(!text) return;
  ensureCurrent();

  addRow('user', text, false);
  input.value = '';

  const bubble = addRow('assistant','', true);

  currentController = new AbortController();
  stopBtn.style.display = 'inline-block';
  sendBtn.disabled = true;

  try{
    const res = await fetch('http://127.0.0.1:8000/chat-stream',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ message:text, history:turns }),
      signal: currentController.signal
    });

    if(!res.body){ bubble.innerHTML = '<p>(Streaming not supported.)</p>'; return; }

    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let full = '';

    while(true){
      const {value, done} = await reader.read();
      if(done) break;
      const chunk = decoder.decode(value, {stream:true});
      full += chunk;
      bubble.innerHTML = renderMarkdown(full);
      scroller.scrollTop = scroller.scrollHeight;
    }

    turns.push({role:'user', content:text});
    turns.push({role:'assistant', content:full});
    const conv = conversations.find(c=>c.id===currentId);
    if(conv){
      conv.turns = turns;
      if(conv.title==='New chat' && text) conv.title = text.slice(0,40);
    }
    saveAll(); renderHistory();

  }catch(e){
    if(e.name !== 'AbortError'){
      bubble.innerHTML = `<p>Error: ${escapeHtml(e.message)}</p>`;
    }
  }finally{
    currentController = null;
    stopBtn.style.display = 'none';
    sendBtn.disabled = false;
  }
}
function stopMessage(){
  if(currentController){ currentController.abort(); }
}

/* ===== Keyboard & init ===== */
sendBtn.onclick = sendMessage;
stopBtn.onclick = stopMessage;
input.addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && !e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});

// init
if(!currentId && conversations.length){ currentId = conversations[0].id; }
if(!currentId){
  const id = newId();
  conversations.unshift({id, title:'New chat', turns:[], created:Date.now()});
  currentId = id;
  saveAll();
}
renderHistory();
switchConv(currentId);
</script>
</body>
</html>
